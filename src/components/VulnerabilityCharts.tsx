import { 
  PieChart, 
  Pie, 
  Cell, 
  ResponsiveContainer, 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  Tooltip,
  Legend,
  AreaChart,
  Area
} from "recharts";
import { cn } from "@/lib/utils";
import { motion } from "framer-motion";

interface VulnerabilityChartsProps {
  severityData: { name: string; value: number; color: string }[];
  toolData: { name: string; vulnerabilities: number }[];
  trendData: { date: string; critical: number; high: number; medium: number; low: number }[];
  className?: string;
}

const SEVERITY_COLORS = {
  critical: 'hsl(0, 72%, 51%)',
  high: 'hsl(25, 95%, 53%)',
  medium: 'hsl(45, 93%, 47%)',
  low: 'hsl(142, 71%, 45%)',
  info: 'hsl(199, 89%, 48%)'
};

const CustomTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-popover border border-border rounded-lg p-3 shadow-lg">
        <p className="text-sm font-medium text-foreground">{label}</p>
        {payload.map((entry: any, index: number) => (
          <p key={index} className="text-xs text-muted-foreground">
            <span style={{ color: entry.color }}>{entry.name}: </span>
            <span className="font-mono">{entry.value}</span>
          </p>
        ))}
      </div>
    );
  }
  return null;
};

export function VulnerabilityCharts({ 
  severityData, 
  toolData, 
  trendData, 
  className 
}: VulnerabilityChartsProps) {
  return (
    <div className={cn("grid grid-cols-1 lg:grid-cols-2 gap-6", className)}>
      {/* Severity Distribution Pie Chart */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, delay: 0.1 }}
        className="rounded-lg border border-border bg-card p-6"
      >
        <h3 className="text-lg font-semibold text-foreground mb-4">
          Vulnerabilities by Severity
        </h3>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={severityData}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={90}
                paddingAngle={2}
                dataKey="value"
                stroke="hsl(var(--background))"
                strokeWidth={2}
              >
                {severityData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip content={<CustomTooltip />} />
              <Legend 
                formatter={(value) => (
                  <span className="text-xs text-muted-foreground capitalize">{value}</span>
                )}
              />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </motion.div>

      {/* Vulnerabilities by Tool Bar Chart */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, delay: 0.2 }}
        className="rounded-lg border border-border bg-card p-6"
      >
        <h3 className="text-lg font-semibold text-foreground mb-4">
          Findings by Tool
        </h3>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={toolData} layout="vertical">
              <XAxis 
                type="number" 
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                axisLine={{ stroke: 'hsl(var(--border))' }}
              />
              <YAxis 
                type="category" 
                dataKey="name" 
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                axisLine={{ stroke: 'hsl(var(--border))' }}
                width={80}
              />
              <Tooltip content={<CustomTooltip />} />
              <Bar 
                dataKey="vulnerabilities" 
                fill="hsl(var(--primary))" 
                radius={[0, 4, 4, 0]}
                name="Vulnerabilities"
              />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </motion.div>

      {/* Trend Area Chart - Full Width */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, delay: 0.3 }}
        className="lg:col-span-2 rounded-lg border border-border bg-card p-6"
      >
        <h3 className="text-lg font-semibold text-foreground mb-4">
          Vulnerability Trend (7 Days)
        </h3>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={trendData}>
              <defs>
                <linearGradient id="criticalGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={SEVERITY_COLORS.critical} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={SEVERITY_COLORS.critical} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="highGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={SEVERITY_COLORS.high} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={SEVERITY_COLORS.high} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="mediumGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={SEVERITY_COLORS.medium} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={SEVERITY_COLORS.medium} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="lowGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={SEVERITY_COLORS.low} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={SEVERITY_COLORS.low} stopOpacity={0}/>
                </linearGradient>
              </defs>
              <XAxis 
                dataKey="date" 
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                axisLine={{ stroke: 'hsl(var(--border))' }}
              />
              <YAxis 
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                axisLine={{ stroke: 'hsl(var(--border))' }}
              />
              <Tooltip content={<CustomTooltip />} />
              <Legend 
                formatter={(value) => (
                  <span className="text-xs text-muted-foreground capitalize">{value}</span>
                )}
              />
              <Area 
                type="monotone" 
                dataKey="critical" 
                stackId="1"
                stroke={SEVERITY_COLORS.critical} 
                fill="url(#criticalGradient)"
                strokeWidth={2}
              />
              <Area 
                type="monotone" 
                dataKey="high" 
                stackId="1"
                stroke={SEVERITY_COLORS.high} 
                fill="url(#highGradient)"
                strokeWidth={2}
              />
              <Area 
                type="monotone" 
                dataKey="medium" 
                stackId="1"
                stroke={SEVERITY_COLORS.medium} 
                fill="url(#mediumGradient)"
                strokeWidth={2}
              />
              <Area 
                type="monotone" 
                dataKey="low" 
                stackId="1"
                stroke={SEVERITY_COLORS.low} 
                fill="url(#lowGradient)"
                strokeWidth={2}
              />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </motion.div>
    </div>
  );
}
